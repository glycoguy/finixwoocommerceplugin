function nonEmptyValue(e){return null!=e&&""!==e&&""!==e.trim()}function triggerApplePaySubmitError(e){var a=jQuery("form.woocommerce-checkout, form#order_review");void 0!==e&&0!==e.length||(e='<div class="woocommerce-error">'+finix_params.text.error_processing+"</div>"),jQuery(".woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message, .is-error, .is-success").remove(),a.prepend('<div class="woocommerce-NoticeGroup woocommerce-NoticeGroup-checkout">'+e+"</div>"),a.removeClass("processing").unblock(),a.find(".input-text, select, input:checkbox").trigger("validate").trigger("blur");let t=jQuery(".woocommerce-NoticeGroup-updateOrderReview, .woocommerce-NoticeGroup-checkout");t.length||(t=a),jQuery.scroll_to_notices(t),a.find('.woocommerce-error[tabindex="-1"], .wc-block-components-notice-banner.is-error[tabindex="-1"]').trigger("focus"),jQuery(document.body).trigger("checkout_error",[e])}function validateWhetherApplePaySelected(){var e;jQuery('input[name="payment_method"]:checked').val()===finix_apple_pay_params.gateway&&((e=document.querySelector("#finix-apple-pay-button"))&&"block"!==e.style.display&&(e.style.display="block"),e=document.querySelector("#place_order"))&&!e.classList.contains("finix-hide-place-order")&&e.classList.add("finix-hide-place-order")}function beginFinixApplePaySession(i){i.onvalidatemerchant=function(e){try{var a;e.validationURL?(a={provider:"APPLE_PAY",validation_url:e.validationURL,merchant_identity:finix_apple_pay_params.merchant_identity,domain_name:window.location.hostname,display_name:finix_apple_pay_params.merchant_name,session_request:!0,wp_nonce:finix_apple_pay_params.nonce},fetch(finix_apple_pay_params.url.webhook,{method:"POST",body:JSON.stringify(a),headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{var e=e?.response?.session_details||"";e?(e=JSON.parse(e),i.completeMerchantValidation(e)):triggerApplePaySubmitError()})):triggerApplePaySubmitError()}catch(e){throw e}},i.onpaymentauthorized=function(e){try{var a,t=e.payment;t?(a={provider:"APPLE_PAY",payment_token:JSON.stringify(t),process_payment:!0,merchant_identity:finix_apple_pay_params.merchant_identity,wp_nonce:finix_apple_pay_params.nonce,billing_info:retrieveBillingData()},document.querySelector("#finix_apple_pay_order_id")&&document.querySelector("#finix_apple_pay_order_key")&&(a.order_id=document.querySelector("#finix_apple_pay_order_id").value,a.order_key=document.querySelector("#finix_apple_pay_order_key").value),fetch(finix_apple_pay_params.url.webhook,{method:"POST",body:JSON.stringify(a),headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{201===e.status?(i.completePayment(i.STATUS_SUCCESS),document.querySelector("#finix_apple_pay_success").value="true",document.querySelector("#finix_apple_pay_transaction_id").value=e.response.id,jQuery("form.woocommerce-checkout, form#order_review").trigger("submit")):(triggerApplePaySubmitError(),i.completePayment(i.STATUS_FAILURE),document.querySelector("#finix_apple_pay_success").value=!1)}).catch(e=>{triggerApplePaySubmitError(),i.completePayment(i.STATUS_FAILURE),document.querySelector("#finix_apple_pay_success").value=!1})):i.completePayment(i.STATUS_FAILURE)}catch(e){throw e}},i.oncancel=function(e){},i.begin()}function retrieveBillingData(){let e={};return document.querySelector("#billing_country")&&document.querySelector("#billing_email")?(e={first_name:document.querySelector("#billing_first_name")?.value||"",last_name:document.querySelector("#billing_last_name")?.value||"",address1:document.querySelector("#billing_address_1")?.value||"",city:document.querySelector("#billing_city")?.value||"",postcode:document.querySelector("#billing_postcode")?.value||"",country:document.querySelector("#billing_country")?.value||"",state:"hidden"!==document.querySelector("#billing_state")?.type&&document.querySelector("#billing_state")?.value||"",email:document.querySelector("#billing_email")?.value||""},document.querySelector("#billing_phone")?.closest("p.form-row")?.classList.contains("validate-required")&&(e.phone=document.querySelector("#billing_phone")?.value||"")):e={first_name:finix_apple_pay_params.billing_data.first_name,last_name:finix_apple_pay_params.billing_data.last_name,address1:finix_apple_pay_params.billing_data.address_1,city:finix_apple_pay_params.billing_data.city,postcode:finix_apple_pay_params.billing_data.postcode,country:finix_apple_pay_params.billing_data.country,state:finix_apple_pay_params.billing_data.state,email:finix_apple_pay_params.billing_data.email,phone:finix_apple_pay_params.billing_data.phone},e}function retrieveShippingData(){var e,a,t,i,n,p=retrieveBillingData();return""===p.address1||""===p.city||"US"===p.country&&""===p.state||""===p.postcode||""===p.country?(triggerApplePaySubmitError('<div class="woocommerce-error">'+finix_apple_pay_params.text.error_billing+"</div>"),!1):(e=document.querySelector("#shipping_country")?.value||"",a=document.querySelector("#shipping_state")?.value||"",t=document.querySelector("#shipping_postcode")?.value||"",i=document.querySelector("#shipping_city")?.value||"",n=document.querySelector("#shipping_address_1")?.value||"",p={shipping_country:p.country,shipping_state:p.state,shipping_postcode:p.postcode,shipping_city:p.city,shipping_address_1:p.address1},nonEmptyValue(e)&&(p.shipping_country=e),nonEmptyValue(a)&&(p.shipping_state=a),nonEmptyValue(t)&&(p.shipping_postcode=t),nonEmptyValue(i)&&(p.shipping_city=i),nonEmptyValue(n)&&(p.shipping_address_1=n),p)}function validateShippingData(e){return new Promise(a=>{e.nonce=finix_apple_pay_params.nonce,fetch(finix_apple_pay_params.url.ajax+"?action=validate_shipping_method",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(e=>e.json()).then(e=>{!0===e.success?a(!0):(triggerApplePaySubmitError('<div class="woocommerce-error">'+e.data.message+"</div>"),a(!1))}).catch(()=>a(!1))})}jQuery(function(){if(window.ApplePaySession&&window.ApplePaySession.canMakePayments()&&window.ApplePaySession.supportsVersion(10)){if(jQuery("form.woocommerce-checkout, form#order_review").length){let e=0,a=setInterval(function(){e++,validateWhetherApplePaySelected(),5<=e&&clearInterval(a)},1e3),t=(jQuery(document).on("change",'input[name="payment_method"]',function(){i()}),jQuery(document).on("updated_checkout",function(){finix_apple_pay_params.amount=FinixHelpers.getUpdatedTotal(),fetch(finix_apple_pay_params.url.ajax+"?action=get_order_tracking_details",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nonce:finix_apple_pay_params.nonce})}).then(e=>e.json()).then(e=>{!0===e.success&&(finix_apple_pay_params.subtotal=e.data.subtotal||finix_apple_pay_params.amount,finix_apple_pay_params.shipping_amount=e.data.shipping_amount||0,finix_apple_pay_params.tax_amount=e.data.tax_amount||0,finix_apple_pay_params.products=e.data.products||[],finix_apple_pay_params.coupons=e.data.coupons||[],finix_apple_pay_params.currency_code=e.data.currency_code||finix_apple_pay_params.currency_code)}).catch(e=>{}),n()}),setTimeout(()=>{i(),n(),clearTimeout(t)},2e3));function i(){let e,a;jQuery('input[name="payment_method"]:checked').val()===finix_apple_pay_params.gateway?((a=document.querySelector("#finix-apple-pay-button")).style.display="block",(e=document.querySelector("#place_order")).classList.add("finix-hide-place-order"),e.style.display="none"):((a=document.querySelector("#finix-apple-pay-button")).style.display="none",(e=document.querySelector("#place_order")).classList.remove("finix-hide-place-order"),e.style.display="block")}function n(){var e=document.getElementById("finix-apple-pay-button");e&&!e.dataset.finixBound&&(e.addEventListener("click",()=>{var e=retrieveShippingData();let a=[];Object.values(finix_apple_pay_params.products).forEach(e=>{0!==parseFloat(e.total)&&a.push({label:1<e.quantity?e.name+" x"+e.quantity:e.name,type:"final",amount:e.total})}),a.push({label:finix_apple_pay_params.text.subtotal,type:"final",amount:finix_apple_pay_params.subtotal||finix_apple_pay_params.amount}),a.push(...finix_apple_pay_params.coupons.map(e=>({label:finix_apple_pay_params.text.discount_code+" "+e.code,type:"final",amount:-1*parseFloat(e.total).toFixed(2)}))),0<finix_apple_pay_params.shipping_amount&&a.push({label:finix_apple_pay_params.text.shipping,type:"final",amount:finix_apple_pay_params.shipping_amount}),0<finix_apple_pay_params.tax_amount&&a.push({label:finix_apple_pay_params.text.tax,type:"final",amount:finix_apple_pay_params.tax_amount});var t={countryCode:finix_apple_pay_params.merchant_country,currencyCode:finix_apple_pay_params.currency_code,merchantCapabilities:["supports3DS"],supportedNetworks:["visa","masterCard","amex","discover"],total:{label:finix_apple_pay_params.merchant_name,amount:finix_apple_pay_params.amount},lineItems:a};let i=new window.ApplePaySession(10,t);return validateShippingData(e).then(e=>{e&&beginFinixApplePaySession(i)}),!1}),e.dataset.finixBound="1")}}}else{var e=document.querySelector("fieldset#wc-finix_apple_pay_gateway-form");e&&(e.style.display="none",document.querySelector(".wc_payment_method.payment_method_finix_apple_pay_gateway").style.display="none",e=document.querySelector("#finix-apple-pay-button"))&&(e.style.display="none")}});