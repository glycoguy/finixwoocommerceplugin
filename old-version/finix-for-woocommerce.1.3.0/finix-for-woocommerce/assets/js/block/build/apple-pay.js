(()=>{"use strict";const e=window.wp.element,a=window.wp.i18n,t=window.wc.wcBlocksRegistry,n=window.wp.htmlEntities,p=window.wc.wcSettings,i=window.wc.wcBlocksData,s=window.wp.data,o=window.ReactJSXRuntime,_="finix_apple_pay_gateway",r=(0,p.getSetting)("finix_apple_pay_gateway_data",{}),l=(0,n.decodeEntities)(r.title)||(0,a.__)("Pay with Apple Pay","finix-for-woocommerce"),c=e=>e&&""!==e.trim(),m=a=>{const{PaymentMethodLabel:t}=a.components,n=()=>(0,e.createElement)("img",{src:r.icon,style:{position:"absolute",right:"20px",height:"30px",width:"auto"}});return(0,o.jsx)(t,{text:l,icon:(0,o.jsx)(n,{})})},y=t=>{const{eventRegistration:n,emitResponse:p}=t,{onPaymentSetup:o}=n,{shippingAddress:l,billingAddress:m,totals:y,coupons:d,items:u}=(0,s.useSelect)(e=>e(i.cartStore).getCartData(),[]),[f,x]=(0,e.useState)(!0),w=(0,e.useRef)(null),g=(0,e.useRef)(!1);return(0,e.useEffect)(()=>{finix_apple_pay_params.shipping_data=l;const e=JSON.stringify(l||{});g.current&&e===w.current||(w.current=e,g.current=!0,(async()=>{const e=await new Promise(e=>{let a=(()=>{const e=finix_apple_pay_params.billing_data,a=finix_apple_pay_params.shipping_data;return{shipping_country:a.country||e.country||"",shipping_state:a.state||e.state||"",shipping_postcode:a.postcode||e.postcode||"",shipping_city:a.city||e.city||"",shipping_address_1:a.address_1||e.address1||""}})();a.nonce=finix_apple_pay_params.nonce,fetch(finix_apple_pay_params.url.ajax+"?action=validate_shipping_method",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}).then(e=>e.json()).then(a=>{!0===a.success?e(!0):e(!1)}).catch(()=>e(!1))});x(e)})())},[l]),(0,e.useEffect)(()=>{finix_apple_pay_params.billing_data=m},[m]),(0,e.useEffect)(()=>{finix_apple_pay_params.amount=(y.total_price/100).toFixed(2),finix_apple_pay_params.currency_code=y.currency_code,finix_apple_pay_params.subtotal=(y.total_items/100).toFixed(2),finix_apple_pay_params.shipping_amount=(y.total_shipping/100).toFixed(2),finix_apple_pay_params.tax_amount=(y.total_tax/100).toFixed(2)},[y]),(0,e.useEffect)(()=>{finix_apple_pay_params.coupons=d.map(e=>({code:e.code,total:(e.totals.total_discount/100).toFixed(2)}))},[d]),(0,e.useEffect)(()=>{finix_apple_pay_params.items=u.map(e=>({name:e.name,quantity:e.quantity,image:e.images.length&&e.images.length>0?e.images[0].thumbnail:"",total:e.prices.price*e.quantity}))},[u]),(0,e.useEffect)(()=>o(async()=>{if(!f)return{type:p.responseTypes.ERROR,message:(0,a.__)("Please make sure shipping and billing information is correct.","finix-for-woocommerce")};let e=[];Object.values(finix_apple_pay_params.products).forEach(a=>{0!==parseFloat(a.total)&&e.push({label:a.quantity>1?`${a.name} x${a.quantity}`:a.name,type:"final",amount:a.total})}),e.push({label:(0,a.__)("Subtotal","finix-for-woocommerce"),type:"final",amount:finix_apple_pay_params.subtotal||finix_apple_pay_params.amount}),e.push(...finix_apple_pay_params.coupons.map(e=>({label:(0,a.__)("Discount code:","finix-for-woocommerce")+" "+e.code,type:"final",amount:-1*parseFloat(e.total).toFixed(2)}))),finix_apple_pay_params.shipping_amount>0&&e.push({label:(0,a.__)("Shipping","finix-for-woocommerce"),type:"final",amount:finix_apple_pay_params.shipping_amount||"0.00"}),finix_apple_pay_params.tax_amount>0&&e.push({label:(0,a.__)("Tax","finix-for-woocommerce"),type:"final",amount:finix_apple_pay_params.tax_amount||"0.00"});const t=new window.ApplePaySession(10,{countryCode:finix_apple_pay_params.merchant_country,currencyCode:finix_apple_pay_params.currency_code,merchantCapabilities:["supports3DS"],supportedNetworks:["visa","masterCard","amex","discover"],total:{label:finix_apple_pay_params.merchant_name,amount:finix_apple_pay_params.amount},lineItems:e});try{const e=await(async e=>new Promise((a,t)=>{e.onvalidatemerchant=async a=>{try{if(!c(a.validationURL))return void t(finix_apple_pay_params.text.error_processing);const n={provider:"APPLE_PAY",validation_url:a.validationURL,merchant_identity:finix_apple_pay_params.merchant_identity,domain_name:window.location.hostname,display_name:finix_apple_pay_params.merchant_name,session_request:!0,wp_nonce:finix_apple_pay_params.nonce},p=await fetch(finix_apple_pay_params.url.webhook,{method:"POST",body:JSON.stringify(n),headers:{"Content-Type":"application/json"}}),i=await p.json(),s=i?.response?.session_details||"";if(!s)return void t(finix_apple_pay_params.text.error_processing);const o=JSON.parse(s);e.completeMerchantValidation(o)}catch(e){t(finix_apple_pay_params.text.error_processing)}},e.onpaymentauthorized=async n=>{try{const p=n.payment;if(!p)return e.completePayment(window.ApplePaySession.STATUS_FAILURE),void t(finix_apple_pay_params.text.error_processing);const i={provider:"APPLE_PAY",payment_token:JSON.stringify(p),process_payment:!0,merchant_identity:finix_apple_pay_params.merchant_identity,wp_nonce:finix_apple_pay_params.nonce,billing_info:finix_apple_pay_params.billing_data},s=await fetch(finix_apple_pay_params.url.webhook,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}),o=await s.json();201===o.status?(e.completePayment(window.ApplePaySession.STATUS_SUCCESS),document.getElementById("finix_apple_pay_success").value=!0,document.getElementById("finix_apple_pay_transaction_id").value=o.response.id,a(!0)):(e.completePayment(window.ApplePaySession.STATUS_FAILURE),document.getElementById("finix_apple_pay_success").value=!1,document.getElementById("finix_apple_pay_transaction_id").value="",t(o.data.message))}catch(a){e.completePayment(window.ApplePaySession.STATUS_FAILURE),document.getElementById("finix_apple_pay_success").value=!1,t(finix_apple_pay_params.text.error_processing)}},e.oncancel=async function(){t()},e.begin()}))(t);if(!0===e)return{type:p.responseTypes.SUCCESS,meta:{paymentMethodData:{finix_apple_pay_success:document.getElementById("finix_apple_pay_success").value,finix_apple_pay_transaction_id:document.getElementById("finix_apple_pay_transaction_id").value,finix_nonce:finix_apple_pay_params.nonce}}}}catch(e){return{type:p.responseTypes.FAIL,message:e?.toString()}}return{type:p.responseTypes.FAIL,message:finix_apple_pay_params.text.error_processing}}),[o]),(0,e.createElement)("fieldset",{id:"wc-"+_+"-form",style:{background:"transparent",padding:"0"}},c(r.description)?(0,e.createElement)("div",{},(0,e.createElement)("p",{dangerouslySetInnerHTML:{__html:r.description}})):null,(0,e.createElement)("apple-pay-button",{id:"finix-apple-pay-button",buttonstyle:finix_apple_pay_params.button_style,type:finix_apple_pay_params.button_type,locale:finix_apple_pay_params.button_locale}),(0,e.createElement)("input",{type:"hidden",name:"finix_apple_pay_success",id:"finix_apple_pay_success"}),(0,e.createElement)("input",{type:"hidden",name:"finix_apple_pay_transaction_id",id:"finix_apple_pay_transaction_id"}))},d=()=>{};(0,t.registerPaymentMethod)({name:_,label:(0,o.jsx)(m,{}),content:(0,o.jsx)(y,{}),edit:(0,o.jsx)(d,{}),canMakePayment:()=>window.ApplePaySession&&window.ApplePaySession.canMakePayments()&&window.ApplePaySession.supportsVersion(10),ariaLabel:l,supports:{features:r.supports}})})();