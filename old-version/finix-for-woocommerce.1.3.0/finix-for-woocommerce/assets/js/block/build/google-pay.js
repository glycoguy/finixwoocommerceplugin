(()=>{"use strict";const e=window.wp.element,t=window.wp.i18n,a=window.wc.wcBlocksRegistry,n=window.wp.htmlEntities,o=window.wc.wcSettings,i=window.wc.wcBlocksData,s=window.wp.data;class r{static paymentsClient=null;static baseRequest={apiVersion:2,apiVersionMinor:0};static environment="sandbox"===finix_google_pay_params.environment?"TEST":"PRODUCTION";static allowedCardNetworks=["AMEX","DISCOVER","INTERAC","JCB","MASTERCARD","VISA"];static allowedCardAuthMethods=["PAN_ONLY","CRYPTOGRAM_3DS"];static tokenizationSpecification={type:"PAYMENT_GATEWAY",parameters:{gateway:"finix",gatewayMerchantId:finix_google_pay_params.merchant_identity}};static baseCardPaymentMethod={type:"CARD",parameters:{allowedAuthMethods:r.allowedCardAuthMethods,allowedCardNetworks:r.allowedCardNetworks}};static cardPaymentMethod={...r.baseCardPaymentMethod,tokenizationSpecification:r.tokenizationSpecification};static getPaymentsClient(){return r.paymentsClient||(r.paymentsClient=new google.payments.api.PaymentsClient({environment:r.environment})),r.paymentsClient}static getIsReadyToPayRequest(){return{...r.baseRequest,allowedPaymentMethods:[r.baseCardPaymentMethod]}}static getTransactionInfo(){return{countryCode:finix_google_pay_params.merchant_country,currencyCode:finix_google_pay_params.currency_code,totalPriceStatus:"FINAL",totalPrice:finix_google_pay_params.amount}}static getPaymentDataRequest(){return{...r.baseRequest,allowedPaymentMethods:[r.cardPaymentMethod],transactionInfo:r.getTransactionInfo(),merchantInfo:{merchantId:finix_google_pay_params.google_merchant_id,merchantName:finix_google_pay_params.merchant_name}}}static prefetchPaymentData(){r.getPaymentsClient().prefetchPaymentData(r.getPaymentDataRequest())}static processPayment=async()=>{const e=(0,t.__)("There was an error while processing the payment using Google Pay.","finix-for-woocommerce");try{const t=(await r.getPaymentsClient().loadPaymentData(r.getPaymentDataRequest())).paymentMethodData.tokenizationData.token;if(!t)throw new Error(e);const a={provider:"GOOGLE_PAY",payment_token:t,process_payment:!0,merchant_identity:finix_google_pay_params.merchant_identity,wp_nonce:finix_google_pay_params.nonce,billing_info:finix_google_pay_params.billing_data},n=await fetch(finix_google_pay_params.url.webhook,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}).then(e=>e.json());if(201===n.status)return document.getElementById("finix_google_pay_success").value=!0,document.getElementById("finix_google_pay_transaction_id").value=n.response.id,!0;throw document.getElementById("finix_google_pay_success").value=!1,document.getElementById("finix_google_pay_transaction_id").value="",new Error(e)}catch(t){throw new Error(t.message||e)}};static triggerPayment(){const e=document.querySelector(".wc-block-components-checkout-place-order-button");e&&e.click()}}const _=window.ReactJSXRuntime,c="finix_google_pay_gateway",p=(0,o.getSetting)("finix_google_pay_gateway_data",{}),g=(0,n.decodeEntities)(p.title)||(0,t.__)("Pay with Google Pay","finix-for-woocommerce"),l=t=>{const{PaymentMethodLabel:a}=t.components,n=()=>(0,e.createElement)("img",{src:p.icon});return(0,_.jsx)(a,{text:g,icon:(0,_.jsx)(n,{})})},y=a=>{const{eventRegistration:n,emitResponse:o}=a,{onPaymentSetup:_}=n,{shippingAddress:g,billingAddress:l,totals:y}=(0,s.useSelect)(e=>e(i.cartStore).getCartData(),[]);return(0,e.useEffect)(()=>{finix_google_pay_params.shipping_data=g},[g]),(0,e.useEffect)(()=>{finix_google_pay_params.billing_data=l},[l]),(0,e.useEffect)(()=>{finix_google_pay_params.amount=(y.total_price/100).toFixed(2),finix_google_pay_params.currency_code=y.currency_code},[y]),(0,e.useEffect)(()=>{const e=r.getPaymentsClient();return e.isReadyToPay(r.getIsReadyToPayRequest()).then(t=>{if(t.result){const t=document.querySelector("#wc-finix-google-pay-form"),a=e.createButton({onClick:r.triggerPayment,allowedPaymentMethods:[r.cardPaymentMethod],buttonColor:finix_google_pay_params.button_color,buttonType:finix_google_pay_params.button_type,buttonRadius:finix_google_pay_params.button_radius,buttonLocale:finix_google_pay_params.button_locale});t.appendChild(a),r.prefetchPaymentData()}}).catch(e=>({type:o.responseTypes.ERROR,message:(0,t.__)("There was an error while initializing Google Pay. Please check all the details and try again.","finix-for-woocommerce")})),_(async()=>{if(!await(()=>{let e=(()=>{const e=finix_google_pay_params.billing_data,t=finix_google_pay_params.shipping_data;return{shipping_country:t.country||e.country||"",shipping_state:t.state||e.state||"",shipping_postcode:t.postcode||e.postcode||"",shipping_city:t.city||e.city||"",shipping_address_1:t.address_1||e.address1||""}})();return e.nonce=finix_google_pay_params.nonce,new Promise(t=>{fetch(finix_google_pay_params.url.ajax+"?action=validate_shipping_method",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(e=>e.json()).then(e=>{t(!0===e.success)}).catch(()=>t(!1))})})())return{type:o.responseTypes.ERROR,message:(0,t.__)("Please make sure shipping and billing information is correct and then try again.","finix-for-woocommerce")};try{return!0===await r.processPayment()?{type:o.responseTypes.SUCCESS,meta:{paymentMethodData:{finix_google_pay_success:document.getElementById("finix_google_pay_success").value,finix_google_pay_transaction_id:document.getElementById("finix_google_pay_transaction_id").value,finix_nonce:finix_google_pay_params.nonce}}}:{type:o.responseTypes.FAIL,message:finix_google_pay_params.text.error_processing}}catch(e){return{type:o.responseTypes.FAIL,message:finix_google_pay_params.text.error_processing}}})},[_]),(0,e.createElement)("fieldset",{id:"wc-"+c+"-form",style:{background:"transparent",padding:"0"}},(m=p.description)&&""!==m.trim()?(0,e.createElement)("div",{},(0,e.createElement)("p",{dangerouslySetInnerHTML:{__html:p.description}})):null,(0,e.createElement)("google-pay-button",{id:"finix-google-pay-button",buttonstyle:finix_google_pay_params.button_style,type:finix_google_pay_params.button_type,locale:finix_google_pay_params.button_locale}),(0,e.createElement)("input",{type:"hidden",name:"finix_google_pay_success",id:"finix_google_pay_success"}),(0,e.createElement)("input",{type:"hidden",name:"finix_google_pay_transaction_id",id:"finix_google_pay_transaction_id"}));var m},m=()=>{};(0,a.registerPaymentMethod)({name:c,label:(0,_.jsx)(l,{}),content:(0,_.jsx)(y,{}),edit:(0,_.jsx)(m,{}),canMakePayment:()=>void 0!==finix_google_pay_params.google_merchant_id&&""!==finix_google_pay_params.google_merchant_id&&!(!google||!google.payments)&&r.getPaymentsClient().isReadyToPay(r.getIsReadyToPayRequest()).then(e=>e.result),ariaLabel:g,supports:{features:p.supports}})})();